<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>GPS ê³ ì • AR ë°ëª¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body, html { margin: 0; overflow: hidden; height: 100%; background: black; }
    video {
      position: absolute; top: 0; left: 0;
      width: 100vw; height: 100vh;
      object-fit: cover; z-index: 0;
    }
    canvas {
      position: absolute; top: 0; left: 0;
      z-index: 1;
    }
    #info {
      position: absolute; top: 10px; left: 10px;
      padding: 8px 12px; background: rgba(0,0,0,0.6);
      color: #fff; font-size: 14px; border-radius: 4px;
      z-index: 2;
    }
  </style>
</head>
<body>
  <video id="cam" autoplay playsinline></video>
  <div id="info">ì´ˆê¸°í™” ì¤‘...</div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
  <script>
    // â€” Utility functions â€”
    const toRad = deg => deg * Math.PI/180;
    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const Ï†1 = toRad(lat1), Ï†2 = toRad(lat2);
      const a = Math.sin(dLat/2)**2 + Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }
    function getBearing(lat1, lon1, lat2, lon2) {
      const Ï†1 = toRad(lat1), Ï†2 = toRad(lat2);
      const Î»1 = toRad(lon1), Î»2 = toRad(lon2);
      const y = Math.sin(Î»2 - Î»1) * Math.cos(Ï†2);
      const x = Math.cos(Ï†1)*Math.sin(Ï†2) - Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î»2 - Î»1);
      return Math.atan2(y, x); // radians, 0 = East, +counterclockwise
    }

    // â€” DOM & state â€”
    const info = document.getElementById("info");
    const video = document.getElementById("cam");
    let target = { lat: null, lon: null };
    let currentOrient = { alpha:0, beta:0, gamma:0 };

    // 1) ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼
    navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" } })
      .then(s => video.srcObject = s)
      .catch(_=> info.innerText="âŒ ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨");

    // 2) Three.js scene/camera/renderer
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ alpha:true, antialias:true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // 3) íë¸Œ ë§Œë“¤ê¸°
    const cube = new THREE.Mesh(
      new THREE.BoxGeometry(1,1,1),
      new THREE.MeshNormalMaterial()
    );
    cube.visible = false;
    scene.add(cube);

    // 4) ê¸°ê¸° íšŒì „ ë°›ì•„ì„œ ì¹´ë©”ë¼ ì—…ë°ì´íŠ¸
    window.addEventListener("deviceorientation", e => {
      currentOrient = {
        alpha: e.alpha||0, beta: e.beta||0, gamma: e.gamma||0
      };
    });
    function applyOrientation() {
      const { alpha, beta, gamma } = currentOrient;
      const euler = new THREE.Euler(
        toRad(beta - 90),  // pitch
        toRad(gamma),      // yaw
        toRad(alpha),      // roll
        "YXZ"
      );
      camera.setRotationFromEuler(euler);
    }

    // 5) ë Œë” ë£¨í”„
    function animate() {
      requestAnimationFrame(animate);
      applyOrientation();
      renderer.render(scene, camera);
    }
    animate();

    // 6) GPS ëª©í‘œ ì§€ì  ì„¤ì • (í˜„ì¬ ìœ„ì¹˜ì—ì„œ ì•½ 10m ë–¨ì–´ì§„ ì )
    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude:lat, longitude:lon } = pos.coords;
      // ì˜ˆì‹œ: ë¶ë™ ë°©í–¥ìœ¼ë¡œ 10m
      const d = 10; // meters
      const bearing = Math.PI/4; // 45Â° (NE)
      // ì˜¤í”„ì…‹ ê³„ì‚° (ìœ„ë„ 1Â° â‰ˆ 111km, ê²½ë„ 1Â°â‰ˆ111kmÃ—cos(lat))
      const dLat = (d * Math.cos(bearing)) / 111000;
      const dLon = (d * Math.sin(bearing)) / (111000 * Math.cos(toRad(lat)));
      target.lat = lat + dLat;
      target.lon = lon + dLon;

      info.innerText = `ğŸ¯ ëª©í‘œ ì„¤ì •: ${target.lat.toFixed(6)}, ${target.lon.toFixed(6)}`;
      cube.visible = true;
    }, () => info.innerText="âŒ ìœ„ì¹˜ ê¶Œí•œ í•„ìš”");

    // 7) ì£¼ê¸°ì ìœ¼ë¡œ ìœ„ì¹˜ ê°±ì‹  â†’ íë¸Œ ìœ„ì¹˜ ê³ ì •
    setInterval(()=>{
      if (target.lat===null) return;
      navigator.geolocation.getCurrentPosition(cur=>{
        const ulat = cur.coords.latitude, ulon = cur.coords.longitude;
        const dist = getDistance(ulat, ulon, target.lat, target.lon);
        const bear = getBearing(ulat, ulon, target.lat, target.lon);
        // Three.js ì›”ë“œ ì¢Œí‘œ (1 unit = 1m)
        const x = dist * Math.sin(bear);
        const z = -dist * Math.cos(bear);
        cube.position.set(x, 0, z);

        info.innerText = `ğŸ“ ë‚¨ì€ ê±°ë¦¬: ${dist.toFixed(1)}m`;
      });
    }, 2000);
  </script>
</body>
</html>
