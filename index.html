<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>GPS 고정 AR 데모</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body, html { margin: 0; overflow: hidden; height: 100%; background: black; }
    video {
      position: absolute; top: 0; left: 0;
      width: 100vw; height: 100vh;
      object-fit: cover; z-index: 0;
    }
    canvas {
      position: absolute; top: 0; left: 0;
      z-index: 1;
    }
    #info {
      position: absolute; top: 10px; left: 10px;
      padding: 8px 12px; background: rgba(0,0,0,0.6);
      color: #fff; font-size: 14px; border-radius: 4px;
      z-index: 2;
    }
  </style>
</head>
<body>
  <video id="cam" autoplay playsinline></video>
  <div id="info">초기화 중...</div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
  <script>
    // — Utility functions —
    const toRad = deg => deg * Math.PI/180;
    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const φ1 = toRad(lat1), φ2 = toRad(lat2);
      const a = Math.sin(dLat/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }
    function getBearing(lat1, lon1, lat2, lon2) {
      const φ1 = toRad(lat1), φ2 = toRad(lat2);
      const λ1 = toRad(lon1), λ2 = toRad(lon2);
      const y = Math.sin(λ2 - λ1) * Math.cos(φ2);
      const x = Math.cos(φ1)*Math.sin(φ2) - Math.sin(φ1)*Math.cos(φ2)*Math.cos(λ2 - λ1);
      return Math.atan2(y, x); // radians, 0 = East, +counterclockwise
    }

    // — DOM & state —
    const info = document.getElementById("info");
    const video = document.getElementById("cam");
    let target = { lat: null, lon: null };
    let currentOrient = { alpha:0, beta:0, gamma:0 };

    // 1) 카메라 스트림
    navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" } })
      .then(s => video.srcObject = s)
      .catch(_=> info.innerText="❌ 카메라 접근 실패");

    // 2) Three.js scene/camera/renderer
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ alpha:true, antialias:true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // 3) 큐브 만들기
    const cube = new THREE.Mesh(
      new THREE.BoxGeometry(1,1,1),
      new THREE.MeshNormalMaterial()
    );
    cube.visible = false;
    scene.add(cube);

    // 4) 기기 회전 받아서 카메라 업데이트
    window.addEventListener("deviceorientation", e => {
      currentOrient = {
        alpha: e.alpha||0, beta: e.beta||0, gamma: e.gamma||0
      };
    });
    function applyOrientation() {
      const { alpha, beta, gamma } = currentOrient;
      const euler = new THREE.Euler(
        toRad(beta - 90),  // pitch
        toRad(gamma),      // yaw
        toRad(alpha),      // roll
        "YXZ"
      );
      camera.setRotationFromEuler(euler);
    }

    // 5) 렌더 루프
    function animate() {
      requestAnimationFrame(animate);
      applyOrientation();
      renderer.render(scene, camera);
    }
    animate();

    // 6) GPS 목표 지점 설정 (현재 위치에서 약 10m 떨어진 점)
    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude:lat, longitude:lon } = pos.coords;
      // 예시: 북동 방향으로 10m
      const d = 10; // meters
      const bearing = Math.PI/4; // 45° (NE)
      // 오프셋 계산 (위도 1° ≈ 111km, 경도 1°≈111km×cos(lat))
      const dLat = (d * Math.cos(bearing)) / 111000;
      const dLon = (d * Math.sin(bearing)) / (111000 * Math.cos(toRad(lat)));
      target.lat = lat + dLat;
      target.lon = lon + dLon;

      info.innerText = `🎯 목표 설정: ${target.lat.toFixed(6)}, ${target.lon.toFixed(6)}`;
      cube.visible = true;
    }, () => info.innerText="❌ 위치 권한 필요");

    // 7) 주기적으로 위치 갱신 → 큐브 위치 고정
    setInterval(()=>{
      if (target.lat===null) return;
      navigator.geolocation.getCurrentPosition(cur=>{
        const ulat = cur.coords.latitude, ulon = cur.coords.longitude;
        const dist = getDistance(ulat, ulon, target.lat, target.lon);
        const bear = getBearing(ulat, ulon, target.lat, target.lon);
        // Three.js 월드 좌표 (1 unit = 1m)
        const x = dist * Math.sin(bear);
        const z = -dist * Math.cos(bear);
        cube.position.set(x, 0, z);

        info.innerText = `📏 남은 거리: ${dist.toFixed(1)}m`;
      });
    }, 2000);
  </script>
</body>
</html>
