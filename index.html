<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>GPS + ìì´ë¡œ ê¸°ë°˜ AR ë°ëª¨</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body, html {
        margin: 0;
        overflow: hidden;
        height: 100%;
        background: black;
      }
      video {
        position: absolute;
        top: 0; left: 0;
        width: 100vw; height: 100vh;
        object-fit: cover;
        z-index: 0;
      }
      canvas {
        position: absolute;
        top: 0; left: 0;
        z-index: 1;
      }
      #info {
        position: absolute;
        top: 10px;
        left: 10px;
        padding: 10px;
        background: rgba(0,0,0,0.6);
        color: white;
        z-index: 2;
        font-size: 14px;
        border-radius: 6px;
      }
    </style>
  </head>
  <body>
    <video id="cam" autoplay playsinline></video>
    <div id="info">GPS ë° ì„¼ì„œ ì´ˆê¸°í™” ì¤‘...</div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>

    <script>
      const info = document.getElementById("info");
      const video = document.getElementById("cam");
      let targetLat, targetLon;

      // í›„ë©´ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¬ë°
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => video.srcObject = stream)
        .catch(() => info.innerText = "âŒ ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨");

      const toRad = deg => deg * Math.PI / 180;
      function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const Ï†1 = toRad(lat1);
        const Ï†2 = toRad(lat2);
        const a = Math.sin(dLat/2)**2 + Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(dLon/2)**2;
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
      }

      // Three.js ê¸°ë³¸ ì„¸íŒ…
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 1000);
      const renderer = new THREE.WebGLRenderer({ alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      // íë¸Œ ìƒì„±
      const geometry = new THREE.BoxGeometry(1, 1, 1);
      const material = new THREE.MeshNormalMaterial();
      const cube = new THREE.Mesh(geometry, material);
      cube.position.set(0, 0, -5); // ì¹´ë©”ë¼ ì „ë°© 5m
      cube.visible = true; // í•­ìƒ í‘œì‹œ (ë””ë²„ê·¸ìš©)
      scene.add(cube);

      // ìì´ë¡œ íšŒì „ ìˆ˜ì‹ 
      let currentRotation = { alpha: 0, beta: 0, gamma: 0 };
      window.addEventListener("deviceorientation", (e) => {
        currentRotation = {
          alpha: e.alpha || 0,
          beta: e.beta || 0,
          gamma: e.gamma || 0
        };
      });

      // ìì´ë¡œ íšŒì „ì„ ì¹´ë©”ë¼ì— ë°˜ì˜
      function updateCameraRotation() {
        const { alpha, beta, gamma } = currentRotation;
        const euler = new THREE.Euler(
          toRad(beta - 90), // pitch
          toRad(gamma),     // yaw
          toRad(alpha),     // roll
          "YXZ"
        );
        camera.setRotationFromEuler(euler);
      }

      function animate() {
        requestAnimationFrame(animate);
        // updateCameraRotation();
        cube.rotation.y += 0.01;
        cube.rotation.x += 0.01;
        renderer.render(scene, camera);
      }

      // GPS ê¸°ë°˜ ëª©í‘œ ì§€ì  ìƒì„± (í˜„ì¬ ìœ„ì¹˜ì—ì„œ ì•½ 2m ë–¨ì–´ì§„ ê³³)
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const offsetLat = 0.000018; // ì•½ 2m
        const offsetLon = 0.000018;
        targetLat = lat + offsetLat;
        targetLon = lon + offsetLon;

        info.innerText = "ğŸ“ ëª©í‘œ ì§€ì  ìƒì„± ì™„ë£Œ. íë¸Œê°€ í•­ìƒ ë³´ì´ë„ë¡ ì„¤ì •ë¨";
        cube.visible = true;
      }, () => {
        info.innerText = "âŒ ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.";
      });

      animate();
    </script>
  </body>
</html>
