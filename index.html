<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Three.js Gyroscope Camera</title>
  <style>
    body { margin: 0; overflow: hidden; }
    #startButton {
      position: absolute;
      top: 20px;
      left: 20px;
      padding: 10px 20px;
      font-size: 16px;
      z-index: 1;
    }
  </style>
</head>
<body>
  <!-- iOS 모션 권한 요청용 버튼 -->
  <button id="startButton">모션 허용</button>

  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.module.js';
    import { DeviceOrientationControls } from 'https://cdn.jsdelivr.net/npm/three@0.150.1/examples/jsm/controls/DeviceOrientationControls.js';

    let camera, scene, renderer, controls;

    init();
    animate();

    function init() {
      // 씬 & 카메라 설정
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(0, 0, 0);

      // 렌더러 설정
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      // 예시용 메시(정육면체) 추가
      const geometry = new THREE.BoxGeometry(1, 1, 1);
      const material = new THREE.MeshNormalMaterial();
      const cube = new THREE.Mesh(geometry, material);
      cube.position.set(0, 0, -5);
      scene.add(cube);

      // DeviceOrientationControls 생성 (초기에는 disabled 상태)
      controls = new DeviceOrientationControls(camera);
      controls.enabled = false;

      // 화면 리사이즈 대응
      window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    }

    function animate() {
      requestAnimationFrame(animate);
      // 모션 센서 값이 들어오면 카메라 회전 업데이트
      controls.update();
      renderer.render(scene, camera);
    }

    // iOS 13+ 권한 요청 및 controls 활성화
    const startButton = document.getElementById('startButton');
    startButton.addEventListener('click', async () => {
      // iOS 13+인지 확인
      if (typeof DeviceOrientationEvent !== 'undefined' &&
          typeof DeviceOrientationEvent.requestPermission === 'function') {

        try {
          const response = await DeviceOrientationEvent.requestPermission();
          if (response === 'granted') {
            controls.connect();
            controls.enabled = true;
            startButton.style.display = 'none';
          } else {
            alert('모션 데이터 권한이 필요합니다.');
          }
        } catch (e) {
          console.error(e);
          alert('모션 권한 요청 중 오류가 발생했습니다.');
        }

      } else {
        // iOS 이전/Android 등: 바로 활성화
        controls.connect();
        controls.enabled = true;
        startButton.style.display = 'none';
      }
    });
  </script>
</body>
</html>
